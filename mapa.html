<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <style>
        #mapa {
            height: 100%;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script type="module">

        let mapa;
        let usuarios = [];
        let frame = 1;

        function actualizacion_logica() {
            let datos = new FormData();
            datos.append('usuario', 'alexis');
            datos.append('contraseña', '8899');

            fetch('android/posiciones', {
                method: 'POST',
                body: datos
            })
                .then((respuesta) => {
                    return respuesta.json();
                })
                .catch(error => {
                    console.error('Error al solicitar los años: ', error);
                })
                .then(respuesta_json => {
                    procesar_logica(respuesta_json);
                });
        }

        async function procesar_logica(respuesta_json) {
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            respuesta_json.forEach((usuario) => {
                let usuario_encontrado = usuarios.find((usuario_buscar) => { return usuario_buscar['id'] == usuario['usuario']; });
                if (usuario_encontrado) {
                    usuario_encontrado['posicion_nueva'] = { lat: usuario['latitud'], lng: usuario['longitud'] };
                } else {

                    let imagen = document.createElement('img');
                    imagen.src = 'https://www.marverrefacciones.mx/android/marcador.png';

                    let marcador = new AdvancedMarkerElement({
                        content: imagen,
                        map: mapa,
                        position: { lat: usuario['latitud'], lng: usuario['longitud'] }
                    });

                    let infowindow = new google.maps.InfoWindow({
                        content: '<p style="margin: 0;" ><strong>' + usuario['usuario'] + ' </strong>' + usuario['Nombre'] + '</p>'
                    });

                    marcador.addListener("click", () => {
                        infowindow.open({
                            anchor: marcador,
                            map: mapa,
                        });
                    });

                    usuarios.push({
                        id: usuario['usuario'],
                        nombre: usuario['Nombre'],
                        marcador: marcador,
                        posicion_inicial: { lat: usuario['latitud'], lng: usuario['longitud'] },
                        posicion_final: { lat: usuario['latitud'], lng: usuario['longitud'] },
                        posicion_nueva: { lat: usuario['latitud'], lng: usuario['longitud'] }
                    });
                }
            });
        }

        async function procesar_vista() {
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            usuarios.forEach((usuario) => {

                if (frame == 1) {
                    usuario['posicion_final'] = { lat: usuario['posicion_nueva']['lat'], lng: usuario['posicion_nueva']['lng'] };
                }

                if (usuario['posicion_inicial']['lat'] != usuario['posicion_final']['lat'] || usuario['posicion_inicial']['lng'] != usuario['posicion_final']['lng']) {

                    let latitud_dif_abs = Math.abs(usuario['posicion_inicial']['lat'] - usuario['posicion_final']['lat']) * frame / 150;
                    let longitud_dif_abs = Math.abs(Math.abs(usuario['posicion_inicial']['lng']) + usuario['posicion_final']['lng']) * frame / 150;

                    let latitud = usuario['posicion_inicial']['lat'] >= usuario['posicion_final']['lat'] ? usuario['posicion_inicial']['lat'] - latitud_dif_abs : usuario['posicion_inicial']['lat'] + latitud_dif_abs;
                    let longitud = usuario['posicion_inicial']['lng'] >= usuario['posicion_final']['lng'] ? usuario['posicion_inicial']['lng'] - longitud_dif_abs : usuario['posicion_inicial']['lng'] + longitud_dif_abs;

                    usuario['marcador'].position = { lat: latitud, lng: longitud };
                }

                if (frame == 150) {
                    usuario['posicion_inicial'] = { lat: usuario['posicion_final']['lat'], lng: usuario['posicion_final']['lng'] };
                }

            });

            if (frame == 150) {
                frame = 1;
            } else {
                frame++;
            }

            setTimeout(procesar_vista, 10);
        }

        async function initMap() {
            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

            mapa = new Map(document.getElementById("mapa"), {
                center: { lat: 25.7951169, lng: -108.99698492 },
                zoom: 13.36,
                mapId: '7845e7dffe8cea37'
            });

            setInterval(actualizacion_logica, 500);
            setTimeout(procesar_vista, 10);
        }

        initMap();
    </script>
</head>

<body>
    <div class="form-floating">
        <select class="form-select" id="floatingSelect" aria-label="Floating label select example">
          <option selected>Open this select menu</option>
          <option value="1">One</option>
          <option value="2">Two</option>
          <option value="3">Three</option>
        </select>
        <label for="floatingSelect">Works with selects</label>
      </div>
    <div id="mapa"></div>
    <script>(g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })
            ({ key: "AIzaSyCAaLR-LdWOBIf1pDXFq8nDi3-j67uiheo", v: "weekly" });</script>
</body>

</html>